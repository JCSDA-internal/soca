test_framework_runtime_config: "--log_level=test_suite"
resolution:
  num_ice_cat: 5
  num_ice_lev: 4
  num_sno_lev: 1
model:
  name: SOCA
  tstep: PT1H
  advance_mom6: 1
  variables: [cicen, hicen, socn, tocn, ssh, hocn]
cost_function:
  cost_type: 4D-Var
  window_begin: WINDOW_BEGIN
  window_length: WINDOW_LENGTH
  variables:
  - cicen
  - hicen
  - socn
  - tocn
  - ssh
  - hocn  
  varchange: Identity  
  Jb:
    Background:
      state:
      - read_from_file: 1
        basename: ./INPUT/
        ocn_filename: MOM.res.nc
        ice_filename: ice_model.res.nc
        date: WINDOW_BEGIN
        variables: [cicen, hicen, socn, tocn, ssh, hocn]
    Covariance:
      covariance: SocaError
      default_seed: 1
      prefix: soca
      datadir: ./bump
      method: cor
      strategy: common      
      new_nicas: 0   # 1: recomputes convol param
      load_nicas: 1  # 1: loads convol param (layout specific)
      sam_read: 0
      sam_write: 1  
      mask_check: 1
      draw_type: random_uniform
      nc1: 100
      ntry: 3
      nrep:  2
      nc3: 10
      dc: 1000.0e3
      nl0r: 1
      minim_algo: "hooke"
      rvflt: 0.0
      lsqrt: 1  
      resol: 8.0
      nicas_interp: bilin
      network: 1
      mpicom: 2 # Number of internal comm steps 
      forced_radii: 1
      rh: 3000e3
      rv: 100
      advmode: 0
      diag_interp: bilin
      date: WINDOW_BEGIN
      variable_changes:
      - varchange: BkgErrFILT
        ocean_depth_min: 1000 # [m]
        rescale_bkgerr: 1.0
        efold_z: 2500.0       # [m]
        variables:                                
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
        inputVariables:
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
        outputVariables:
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn        
      - varchange: BkgErrSOCA
        read_from_file: 3
        basename: ./
        ocn_filename: ocn.bkgerror.nc
        ice_filename: ice.bkgerror.nc
        date: WINDOW_BEGIN
        t_min: 0.0
        t_max: 2.5
        s_min: 0.0 
        s_max: 0.2 
        ssh_min: 0.0 # std ssh=0 => ssh balance applied as  
        ssh_max: 0.0 #              strong constraint
        cicen_min: 0.1
        cicen_max: 0.5
        hicen_min: 10.0
        hicen_max: 100.0
        #fixed_std_sst: 0.005 # OK to create pretty increments
        #fixed_std_sss: 0.001 # but that option should not exist!       
        variables:                                
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
        inputVariables:
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
        outputVariables:
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
      - varchange: VertConvSOCA
        variables:                                
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
        Lz: 10.0
        scale_layer_thick: 1.5
        inputVariables:
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
        outputVariables:
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
      - varchange: BalanceSOCA
        dsdtmax: 0.1
        dsdzmin: 3.0e-6
        dtdzmin: 1.0e-6 
        nlayers: 10        
        inputVariables:
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
        outputVariables:
          variables:
          - cicen
          - hicen
          - socn
          - tocn
          - ssh
          - hocn
  Jo:
    ObsTypes:
    - ObsType: ADT
      ObsData:
        ObsDataOut:
          obsfile: ./Data/OBS_ADT_J3-out.nc
        ObsDataIn:
          obsfile:  ./Data/OBS_ADT_J3.nc
      Covariance:
        covariance: diagonal
    - ObsType: ADT
      ObsData:
        ObsDataOut:
          obsfile: ./Data/OBS_ADT_C2-out.nc
        ObsDataIn:
          obsfile:  ./Data/OBS_ADT_C2.nc
      Covariance:
        covariance: diagonal
    - ObsType: ADT
      ObsData:
        ObsDataOut:
          obsfile: ./Data/OBS_ADT_SA-out.nc
        ObsDataIn:
          obsfile:  ./Data/OBS_ADT_SA.nc
      Covariance:
        covariance: diagonal        

variational:
  iteration:
  - resolution:
      num_ice_cat: 5
      num_ice_lev: 4
      num_sno_lev: 1
    linearmodel:
      varchange: Identity
      version: IdTLM
      tstep: PT1H
      advance_mom6: 0      
      variables: [cicen, hicen, socn, tocn, ssh, hocn]
    ninner: 10
    gradient_norm_reduction: 1e-15
    test: on
    diagnostics:
      departures: bmog1
#  - resolution:
#      num_ice_cat: 5
#      num_ice_lev: 4
#      num_sno_lev: 1
#    linearmodel:
#      varchange: Identity
#      version: IdTLM
#      tstep: PT1H
#      advance_mom6: 0      
#    ninner: 5
#    gradient_norm_reduction: 1e-15
#    test: 'on'
#    diagnostics:
#      departures: bmog2      
#  - resolution:
#      num_ice_cat: 5
#      num_ice_lev: 4
#      num_sno_lev: 1
#    linearmodel:
#      varchange: Identity
#      version: IdTLM
#      tstep: PT1H
#      advance_mom6: 0      
#    ninner: 1
#    gradient_norm_reduction: 1e-15
#    test: 'on'    
minimizer:
  algorithm: DRIPCG
output:
  datadir: Data
  exp: 3dvarfgat
  type: an
final:
  diagnostics:
    departures: oman
