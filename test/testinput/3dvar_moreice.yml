# common filters used later on
_: &land_mask
  filter: Domain Check
  where:
  - variable: {name: GeoVaLs/sea_area_fraction}
    minvalue: 0.5

soca_vars: &soca_vars
  - socn
  - tocn
  - uocn
  - vocn
  - ssh
  - hocn
  - mld
  - layer_depth
  - cicen
  - hicen
  - hsnon
  - aice1_h
  - aice2_h
  - aice3_h
  - aice4_h
  - aice5_h
  - vice1_h
  - vice2_h
  - vice3_h
  - vice4_h
  - vice5_h
  - vsno1_h
  - vsno2_h
  - vsno3_h
  - vsno4_h
  - vsno5_h

cost function:
  cost type: 3D-Var
  time window:
    begin: 2018-04-14T00:00:00Z
    length: P2D
  analysis variables: *soca_vars
  geometry: &geom
    geom_grid_file: data_generated/gridgen/soca_gridspec.72x35x25.nc
    mom6_input_nml: data_static/72x35x25/input.nml
    fields metadata: data_static/fields_metadata_moreice.yml

  background:
    read_from_file: 1
    basename: /home/gvernier/data/bkg/
    ocn_filename: gdas.ocean.t12z.inst.f006.nc
    ice_filename: gdas.ice.t12z.inst.f006.nc
    state variables:
    date: &bkg_date 2018-04-15T00:00:00Z
    state variables: *soca_vars

  background error:
    covariance model: SABER
    saber central block:
      saber block name: EXPLICIT_DIFFUSION
      active variables: [tocn, socn, ssh]
      geometry: *geom
      group mapping:
      - name: group1
        variables: [tocn, socn]
      - name: group2
        variables: [ssh]
      read:
        groups:
        - name: group1
          horizontal:
            filename: data_generated/parameters_diffusion/hz_smaller.nc
          vertical:
            filename: data_generated/parameters_diffusion/vt_5lvls.nc
        - name: group2
          horizontal:
            filename: data_generated/parameters_diffusion/hz_smaller.nc

    date: *bkg_date


    linear variable change:
      input variables: *soca_vars
      output variables: *soca_vars
      linear variable changes:
      - linear variable change name: BkgErrFILT
        ocean_depth_min: 1000 # [m]
        rescale_bkgerr: 1.0
        efold_z: 2500.0       # [m]

  observations:
    observers:
    - obs space:
        name: SeaSurfaceTemp
        obsdataout:
          engine:
            type: H5File
            obsfile: data_output/sst.nc
        obsdatain:
          engine:
            type: H5File
            obsfile: data_static/obs/sst.nc
        simulated variables: [seaSurfaceTemperature]
      obs operator:
        name: Identity
        observation alias file: testinput/obsop_name_map.yml
      obs error:
        covariance model: diagonal

    - obs space:
        name: SeaIceFraction
        obsdataout:
          engine:
            type: H5File
            obsfile: data_output/icec.nc
        obsdatain:
          engine:
            type: H5File
            obsfile: data_static/obs/icec.nc
        simulated variables: [seaIceFraction]
      obs operator:
        name: Identity
        observation alias file: testinput/obsop_name_map.yml
      obs error:
        covariance model: diagonal
      obs filters:
      - *land_mask

variational:
  minimizer:
    algorithm: RPCG
  iterations:
  - geometry: *geom
    ninner: 5
    gradient norm reduction: 1e-15
    test: on
    diagnostics:
      departures: ombg
    online diagnostics:
      write increment: true
      increment:
        state component:
          datadir: data_output
          date: *bkg_date
          exp: 3dvar.iter1
          type: incr

output:
  datadir: data_output
  exp: 3dvar
  type: an

final:
  diagnostics:
    departures: oman

test:
  reference filename: testref/3dvar.test
  test output filename: testoutput/3dvar.test
  float relative tolerance: 2e-4