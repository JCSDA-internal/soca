# common filters used later on
_: &land_mask
  filter: Domain Check
  where:
  - variable: {name: sea_area_fraction@GeoVaLs}
    minvalue: 0.5

cost function:
  cost type: 3D-Var
  window begin: &date_begin 2018-04-14T00:00:00Z
  window length: P2D
  analysis variables: &soca_vars [socn, tocn, ssh, hocn]
  geometry:
    num_ice_cat: 5
    num_ice_lev: 4
    num_sno_lev: 1
    geom_grid_file: soca_gridspec.nc
    mom6_input_nml: ./inputnml/input.nml

  model:
    name: SOCA
    tstep: PT1H
    advance_mom6: 0
    model variables: *soca_vars

  background:
    read_from_file: 1
    basename: ./INPUT/
    ocn_filename: MOM.res.nc
    date: &bkg_date 2018-04-15T00:00:00Z
    state variables: *soca_vars

  background error:
    covariance model: SocaError
    prefix: soca
    datadir: ./bump_lowres
    strategy: specific_univariate
    load_nicas: 1
    lsqrt: 1
    mpicom: 2
    date: 2018-04-15T00:00:00Z
    analysis variables: [tocn, socn, ssh] #*soca_vars

  observations:

  - obs space:
      name: SeaSurfaceTemp
      obsdataout: {obsfile: ./Data/sst.out.nc}
      obsdatain:  {obsfile: ./Data/sst.nc}
      simulated variables: [sea_surface_temperature]
    obs operator:
      name: Identity
    obs error:
      covariance model: diagonal
    obs filters:
    - *land_mask
    - filter: Bounds Check
      minvalue: 5.0
      maxvalue: 30.0
    - filter: Background Check
      threshold: 8
    - filter: Thinning
      amount: 0.1
      random seed: 0

  - obs space:
      name: SeaSurfaceSalinity
      obsdataout: {obsfile: ./Data/sss.out.nc}
      obsdatain:  {obsfile: ./Data/sss.nc}
      simulated variables: [sea_surface_salinity]
    obs operator:
      name: Identity
    obs error:
      covariance model: diagonal
    obs filters:
    - *land_mask
    - filter: Domain Check
      where:
      - variable: {name: sea_surface_temperature@GeoVaLs}
        minvalue: 15

  - obs space:
      name: ADT
      obsdataout: {obsfile: ./Data/adt.out.nc}
      obsdatain:  {obsfile: ./Data/adt.nc}
      simulated variables: [obs_absolute_dynamic_topography]
    obs operator:
      name: ADT
    obs error:
      covariance model: diagonal
    obs filters:
    - *land_mask
    - filter: Domain Check
      where:
      - variable: {name: sea_floor_depth_below_sea_surface@GeoVaLs}
        minvalue: 2000

  - obs space:
      name: InsituTemperature
      obsdataout: {obsfile: ./Data/prof.T.out.nc}
      obsdatain:  {obsfile: ./Data/prof.nc}
      simulated variables: [sea_water_temperature]
    obs operator:
      name: InsituTemperature
    obs error:
      covariance model: diagonal
    obs filters:
    - *land_mask
    - filter: Background Check
      threshold: 5

  - obs space:
      name: InsituSalinity
      obsdataout: {obsfile: ./Data/prof.S.out.nc}
      obsdatain:  {obsfile: ./Data/prof.nc}
      simulated variables: [sea_water_salinity]
    obs operator:
      name: MarineVertInterp
    obs error:
      covariance model: diagonal
    obs filters:
    - *land_mask

variational:
  minimizer:
    algorithm: RPCG
  iterations:
  - geometry:
      num_ice_cat: 5
      num_ice_lev: 4
      num_sno_lev: 1
      geom_grid_file: soca_gridspec.small.nc
      mom6_input_nml: ./inputnml/input_small.nml
    linear model:
      variable change: Identity
      name: IdTLM
      tstep: PT1H
      lm variables: [tocn, socn, ssh, hocn] #*soca_vars
    ninner: 25
    gradient norm reduction: 1e-15
    test: on
    diagnostics:
      departures: ombg
  - geometry:
      num_ice_cat: 5
      num_ice_lev: 4
      num_sno_lev: 1
      geom_grid_file: soca_gridspec.small.nc
      mom6_input_nml: ./inputnml/input_small.nml
    linear model:
      variable change: Identity
      name: IdTLM
      tstep: PT1H
      lm variables: [tocn, socn, ssh, hocn] #*soca_vars
    ninner: 25
    gradient norm reduction: 1e-15
    test: on
    diagnostics:
      departures: ombg

output:
  datadir: Data
  exp: 3dvarsoca
  type: an

final:
  diagnostics:
    departures: oman
