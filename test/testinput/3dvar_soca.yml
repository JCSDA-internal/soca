#
#                               3DVAR (No FGAT)
#
#     <---------------------- window_length (6 hours) ---------------------->
#
# ---|-----------|-----------|-----------|-----------|-----------|-----------|
#    |                                   |                                   |      
# window_begin: 2018-04-14T21:00:00Z     |                           2015-04-15T3:00:00Z
#                                        |
#                       bkg/ana/incr: 2018-04-15T00:00:00Z
#
#

test_framework_runtime_config: "--log_level=test_suite"
resolution:
  num_ice_cat: 5
  num_ice_lev: 4
  num_sno_lev: 1
model:
  name: SOCA
  tstep: PT1H
  advance_mom6: 0
  variables: &soca_vars [cicen, hicen, socn, tocn, ssh, hocn]  
cost_function:
  cost_type: 3D-Var
  window_begin: &date_begin 2018-04-14T00:00:00Z
  window_length: P2D
  variables: *soca_vars
  Jb:
    Background:
      state:
      - read_from_file: 1
        basename: ./INPUT/
        ocn_filename: MOM.res.nc
        ice_filename: ice_model.res.nc
        date: &date_bkg 2018-04-15T00:00:00Z
    Covariance:
      covariance: SocaError
      strategy: common_univariate
      load_nicas: 1
      lsqrt: 1
      mpicom: 2
      date: 2018-04-15T00:00:00Z
      variable_changes:
      - varchange: BkgErrFILT
        ocean_depth_min: 1000 # [m]
        rescale_bkgerr: 1.0
        efold_z: 2500.0       # [m]
        variables:                                
          variables: *soca_vars
        inputVariables:
          variables: *soca_vars
        outputVariables:
          variables: *soca_vars
      - varchange: BkgErrSOCA
        read_from_file: 3
        basename: ./
        ocn_filename: ocn.bkgerror.nc
        ice_filename: ice.bkgerror.nc
        date: *date_bkg
        t_min: 0.0
        t_max: 2.5
        s_min: 0.0 
        s_max: 0.2 
        ssh_min: 0.0 # std ssh=0 => ssh balance applied as  
        ssh_max: 0.0 #              strong constraint
        cicen_min: 0.1
        cicen_max: 0.5
        hicen_min: 10.0
        hicen_max: 100.0
        #fixed_std_sst: 0.005 # OK to create pretty increments
        #fixed_std_sss: 0.001 # but that option should not exist!       
        variables:                                
          variables: *soca_vars
        inputVariables:
          variables: *soca_vars
        outputVariables:
          variables: *soca_vars
      - varchange: VertConvSOCA
        variables:                                
          variables: *soca_vars
        Lz_min: 10.0
        Lz_mld: 1
        Lz_mld_max: 500
        scale_layer_thick: 1.5
        inputVariables:
          variables: *soca_vars
        outputVariables:
          variables: *soca_vars
      - varchange: BalanceSOCA
        dsdtmax: 0.1
        dsdzmin: 3.0e-6
        dtdzmin: 1.0e-6
        nlayers: 10        
        inputVariables:
          variables: *soca_vars
        outputVariables:
          variables: *soca_vars

  Jo:
    ObsTypes:
    - ObsType: ADT
      ObsData:
        ObsDataOut:
          obsfile: ./Data/Jason-2-2018-04-15-soca-out.nc
        ObsDataIn:
          obsfile: ./Data/Jason-2-2018-04-15.nc
      Covariance:
        covariance: diagonal
      ObsFilters:
      - Filter: Background Check
        variables:
        - obs_absolute_dynamic_topography
        threshold: 3
#      - Filter: GOMsaver
#        filename: ./Data/testgeovl.nc
#    - ObsType: InsituTemperature
#      ObsData:
#        ObsDataOut:
#          obsfile: ./Data/profile_2018-04-15-out.nc
#        ObsDataIn:
#          obsfile: ./Data/profile_2018-04-15.nc
#          #obsfile: /home/gvernier/Data/FNMOC/2018041500.profile.nc
#      Covariance:
#        covariance: diagonal
#      ObsFilters:
#      - Filter: Background Check
#        variables:
#        - sea_water_temperature
#        threshold: 3
#    - ObsType: SeaIceFraction
#      ObsData:
#        ObsDataOut:
#          obsfile: ./Data/icec-2018-04-15-soca-out.nc
#        ObsDataIn:
#          obsfile: ./Data/icec-2018-04-15.nc
#      Covariance:
#        covariance: diagonal
#      ObsFilters:
#      - Filter: Background Check
#        variables:
#        - obs_sea_ice_concentration
#        threshold: 3
#    - ObsType: SeaIceThickness
#      ObsData:
#        ObsDataOut:
#          obsfile: ./Data/cryosat2-2018-04-15-soca-out.nc
#        ObsDataIn:
#          obsfile: ./Data/cryosat2-2018-04-15.nc
#      Covariance:
#        covariance: diagonal
#      ObsFilters:
#      - Filter: Background Check
#        variables:
#        - obs_sea_ice_thickness
#        threshold: 3
#    - ObsType: SeaSurfaceTemp
#      ObsData:
#        ObsDataOut:
#          obsfile: ./Data/sst_obs-2018-04-15-soca-out.nc
#        ObsDataIn:
#          obsfile: ./Data/sst_obs-2018-04-15.nc4
#      Covariance:
#        covariance: diagonal
#      variables:
#      - sea_surface_temperature
#      ObsFilters:
#      - Filter: Background Check
#        variables:
#        - sea_surface_temperature
#        threshold: 3

variational:
  iteration:
  - resolution:
      num_ice_cat: 5
      num_ice_lev: 4
      num_sno_lev: 1
    linearmodel:
      varchange: Identity
      version: IdTLM
      tstep: PT1H
      variables: *soca_vars
    ninner: 1
    gradient_norm_reduction: 1e-15
    test: 'on'
    prints:
    diagnostics:
      departures: ombg
#  - resolution:
#      num_ice_cat: 5
#      num_ice_lev: 4
#      num_sno_lev: 1
#    linearmodel:
#      varchange: Identity      
#      version: IdTLM
#      tstep: PT1H
#      variables: [cicen, hicen, socn, tocn, ssh, hocn]
#    ninner: 15
#    gradient_norm_reduction: 1e-15
#    test: 'on'
#    output:
#      datadir: Data
#      exp: 3dvar
#      type: incr

minimizer:
  algorithm: DRIPCG

output:
  datadir: Data
  exp: 3dvarsoca
  type: an

final:
  diagnostics:
    departures: oman
