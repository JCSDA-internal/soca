#
#                               3DVAR (No FGAT)
#
#     <---------------------- window_length (6 hours) ---------------------->
#
# ---|-----------|-----------|-----------|-----------|-----------|-----------|
#    |                                   |                                   |
# window_begin: 2018-04-14T21:00:00Z     |                           2015-04-15T3:00:00Z
#                                        |
#                       bkg/ana/incr: 2018-04-15T00:00:00Z
#
#

resolution:
  num_ice_cat: 5
  num_ice_lev: 4
  num_sno_lev: 1
  mom6_input_nml: ./inputnml/input.nml

model:
  name: PseudoModel
  tstep: PT1H
  variables: &soca_vars [socn, tocn, ssh, hocn, uocn, vocn]
  states:
  - date: 2018-04-15T01:00:00Z
    basename: ./Data/
    ocn_filename: ocn.mom6.fc.2018-04-15T00:00:00Z.PT1H.nc
    read_from_file: 1
  - date: 2018-04-15T02:00:00Z
    basename: ./Data/
    ocn_filename: ocn.mom6.fc.2018-04-15T00:00:00Z.PT2H.nc
    read_from_file: 1
  - date: 2018-04-15T03:00:00Z
    basename: ./Data/
    ocn_filename: ocn.mom6.fc.2018-04-15T00:00:00Z.PT3H.nc
    read_from_file: 1
  - date: 2018-04-15T04:00:00Z
    basename: ./Data/
    ocn_filename: ocn.mom6.fc.2018-04-15T00:00:00Z.PT4H.nc
    read_from_file: 1
  - date: 2018-04-15T05:00:00Z
    basename: ./Data/
    ocn_filename: ocn.mom6.fc.2018-04-15T00:00:00Z.PT5H.nc
    read_from_file: 1
  - date: 2018-04-15T06:00:00Z
    basename: ./Data/
    ocn_filename: ocn.mom6.fc.2018-04-15T00:00:00Z.PT6H.nc
    read_from_file: 1

# common filters used later on
_: &land_mask
  Filter: Domain Check
  where:
  - variable: {name: sea_area_fraction@GeoVaLs}
    minvalue: 0.5

cost_function:
  cost_type: 4D-Var
  window_begin: &date_begin 2018-04-15T00:00:00Z
  window_length: PT6H
  variables: *soca_vars
  varchange: Identity
  Jb:
    Background:
      state:
      - read_from_file: 1
        basename: ./INPUT/
        ocn_filename: MOM.res.nc
        date: &bkg_date 2018-04-15T00:00:00Z

    Covariance:
      covariance: SocaError
      prefix: soca
      datadir: ./bump
      strategy: specific_univariate
      load_nicas: 1
      lsqrt: 1
      mpicom: 2
      date: *bkg_date
      variables: *soca_vars

      variable_changes:

      - varchange: BkgErrFILT
        ocean_depth_min: 1000 # [m]
        rescale_bkgerr: 1.0
        efold_z: 2500.0       # [m]
        inputVariables:
          variables: *soca_vars
        outputVariables:
          variables: *soca_vars

      - varchange: VertConvSOCA
        Lz_min: 10.0
        Lz_mld: 1
        Lz_mld_max: 500
        scale_layer_thick: 1.5
        inputVariables:
          variables: *soca_vars
        outputVariables:
          variables: *soca_vars

      - varchange: BalanceSOCA
        dsdtmax: 0.1
        dsdzmin: 3.0e-6
        dtdzmin: 1.0e-6
        nlayers: 10
        dcdt:
          filename: ./Data/kmask.nc
          name: dcdt
        inputVariables:
          variables: *soca_vars
        outputVariables:
          variables: *soca_vars

  Jo:
    ObsTypes:

    - ObsSpace:
        name: SeaSurfaceTemp
        ObsDataOut: {obsfile: ./Data/sst.out.nc}
        ObsDataIn:  {obsfile: ./Data/sst.nc}
        simulate:   {variables: [ sea_surface_temperature ]}
      ObsOperator:
        name: Identity
      Covariance:
        covariance: diagonal
      ObsFilters:
      - *land_mask
      - Filter: Thinning
        amount: 0.1
        random_seed: 0

    - ObsSpace:
        name: SeaSurfaceSalinity
        ObsDataOut: {obsfile: ./Data/sss.out.nc}
        ObsDataIn:  {obsfile: ./Data/sss.nc}
        simulate:   {variables: [ sea_surface_salinity ]}
      ObsOperator:
        name: Identity
      Covariance:
        covariance: diagonal
      ObsFilters:
      - *land_mask
      - Filter: Domain Check
        where:
        - variable: {name: sea_surface_temperature@GeoVaLs}
          minvalue: 15

    - ObsSpace:
        name: ADT
        ObsDataOut: {obsfile: ./Data/adt.out.nc}
        ObsDataIn:  {obsfile: ./Data/adt.nc}
        simulate:   {variables: [ obs_absolute_dynamic_topography ]}
      ObsOperator:
        name: ADT
      Covariance:
        covariance: diagonal
      ObsFilters:
      - *land_mask

    - ObsSpace:
        name: InsituTemperature
        ObsDataOut: {obsfile: ./Data/prof.T.out.nc}
        ObsDataIn:  {obsfile: ./Data/prof.nc}
        simulate:   {variables: [ sea_water_temperature ]}
      ObsOperator:
        name: InsituTemperature
      Covariance:
        covariance: diagonal
      ObsFilters:
      - *land_mask
      - Filter: Background Check
        threshold: 5

    - ObsSpace:
        name: InsituSalinity
        ObsDataOut: {obsfile: ./Data/prof.S.out.nc}
        ObsDataIn:  {obsfile: ./Data/prof.nc}
        simulate:   {variables: [ sea_water_salinity ]}
      ObsOperator:
        name: MarineVertInterp
      Covariance:
        covariance: diagonal
      ObsFilters:
      - *land_mask

variational:
  iteration:
  - resolution:
      num_ice_cat: 5
      num_ice_lev: 4
      num_sno_lev: 1
      mom6_input_nml: ./inputnml/input.nml
    linearmodel:
      varchange: Identity
      version: IdTLM
      tstep: PT1H
      variables: *soca_vars
    ninner: 1
    gradient_norm_reduction: 1e-15
    test: 'on'
    prints:
    diagnostics:
      departures: ombg

minimizer:
  algorithm: RPCG

output:
  datadir: Data
  exp: 3dvarfgat_pseudo
  type: an

final:
  diagnostics:
    departures: oman
