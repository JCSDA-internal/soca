#======================================================================
# Project settings
#======================================================================
branches:
  only:
    - develop
    - master
    - /.*/travisci_.*$/
    
env:
  global:
    - BUNDLE_URL="https://github.com/JCSDA/soca-bundle.git"
    - MAIN_REPO=soca
    - LIB_REPOS="fms cvmix geokdtree mom6_da_hooks gsw mom6
                 fckit saber oops ioda ufo ioda-converters soca-config"
    - LIB_BUILD_OPT_OOPS="-DENABLE_OOPS_TOYMODELS=OFF"
    - MATCH_REPOS="saber oops ioda ioda-converters ufo soca soca-config"
    - LFS_REPOS=""

language: cpp

services:
  - docker

cache:
  ccache: true
  directories:
  - $HOME/repo.cache


#======================================================================
#======================================================================
before_install:
  - |
    # setup other configurables that the subsequent scripts use
    export MAIN_BUILD_TYPE=Debug
    export LIB_BUILD_TYPE=RelWIthDebInfo
    export BRANCH=$( [[ "$TRAVIS_PULL_REQUEST" == "false" ]] && \
                     echo $TRAVIS_BRANCH || echo $TRAVIS_PULL_REQUEST_BRANCH )

    export_vars="-e REPO_CACHE=/repo.cache -e LIB_REPOS -e LIB_BUILD_TYPE 
                 -e MAIN_REPO -e MAIN_BUILD_TYPE -e CCACHE_DIR=/ccache
                 -e LIB_BUILD_OPT_OOPS"
        
  - |
    # clone and prep the repos
    # note: the main repo is not handled by the prep.sh script,
    #  it is moved from what TravisCI auto checks out
    #  (because TravisCI handles PR merges specially)
    WORK_DIR=$HOME/work
    mkdir -p $WORK_DIR/repo.src; cd $WORK_DIR
    REPO_CACHE=$HOME/repo.cache ${TRAVIS_BUILD_DIR}/.travis/prep.sh
    mv ${TRAVIS_BUILD_DIR} ${WORK_DIR}/repo.src/${MAIN_REPO}

  - |
    # alter file permissions
    chmod 777 -R ~/.ccache
    chmod 777 -R $HOME/repo.cache
    cd ${WORK_DIR} && find . -name \* -exec chmod 777 {} \;

  - |
    # prepare docker image from jcsda/docker:latest
    cd ${WORK_DIR}/repo.src/${MAIN_REPO}/.travis
    docker build -t jcsda/dockerl2 --build-arg=Dockerfile .
    docker images
    ci_env=`bash <(curl -s https://codecov.io/env)`
    docker run -d -t $ci_env $export_vars \
      -v ${WORK_DIR}:/jcsda/work \
      -v $HOME/.ccache:/ccache \
      -v $HOME/repo.cache:/repo.cache \
      --name jcsda_container jcsda/dockerl2
    docker ps -a


#======================================================================
# Here are the run steps
#======================================================================
script:
  - |
    # Build code
    docker exec jcsda_container bash \
     -c 'cd /jcsda/work && /jcsda/work/repo.src/${MAIN_REPO}/.travis/build.sh'

  - |
    # run tests
    docker exec jcsda_container bash \
     -c 'cd /jcsda/work/repo.build/${MAIN_REPO} && ctest --output-on-failure'

  - |
    # upload code coverage
    docker exec jcsda_container bash -c \
      'cd /jcsda/work/repo.src/${MAIN_REPO} \
       && lcov -c -d . -d ../../repo.build/${MAIN_REPO}/ -o coverage.info  --no-external -q \
       && bash <(curl -s https://codecov.io/bash)'